### 漏洞说明

### 跨站脚本漏洞(XSS)

#### 反射型XSS漏洞

直接获取用户输入返回到前端

用户输入str

##### ![image-20211028153817459](img/漏洞代码说明.assets/image-20211028153817459.png)

#### 存储型XSS漏洞

将用户输入内容存储到数据库后读取数据库直接输出到前端

用户输入str

![image-20211028153613107](img/漏洞代码说明.assets/image-20211028153613107.png)

修复方案

输出前端时对用户内容中的特殊字符进行编码处理

![image-20211028153926786](img/漏洞代码说明.assets/image-20211028153926786.png)

### SQL注入漏洞

#### JDBC拼接SQL注入漏洞

JDBC拼接导致SQL注入漏洞产生

![image-20211028154203655](img/漏洞代码说明.assets/image-20211028154203655.png)

**修复方案**

对参数进行预编译绑定

![image-20211028154304993](img/漏洞代码说明.assets/image-20211028154304993.png)

#### Mybatis拼接SQL注入漏洞

Mybatis使用`$`符号即为拼接参数进行操作

![image-20211028154503164](img/漏洞代码说明.assets/image-20211028154503164.png)

![image-20211028154440015](img/漏洞代码说明.assets/image-20211028154440015.png)

**修复方案**

使用`#`符号替代常规`$`符号进行查询

![image-20211028154653498](img/漏洞代码说明.assets/image-20211028154653498.png)

#### Mybatis模糊查询SQL注入漏洞

由于模糊查询在Mybatis中无法直接使用`#`符号，开发使用`$`符号进行模糊查询导致漏洞

![image-20211028155051542](img/漏洞代码说明.assets/image-20211028155051542.png)

![image-20211028155006555](img/漏洞代码说明.assets/image-20211028155006555.png)

**修复方案**

使用concat拼接查询条件，针对mysql数据库如下

![image-20211028155144937](img/漏洞代码说明.assets/image-20211028155144937.png)

其他数据库

![image-20211028155402900](img/漏洞代码说明.assets/image-20211028155402900.png)

#### Mybatis OrderBy 查询SQL注入漏洞

使用order by进行排序查询时，由于没有对传入的参数进行合理的判断，同时order by无法进行预编译以及参数化查询，导致存在SQL注入漏洞

![image-20211028155504345](img/漏洞代码说明.assets/image-20211028155504345.png)

![image-20211028155537323](img/漏洞代码说明.assets/image-20211028155537323.png)

**修复方案**

采用白名单对查询参数进行限制，防止SQL注入漏洞

![image-20211028155700177](img/漏洞代码说明.assets/image-20211028155700177.png)

### 越权漏洞

#### 水平越权漏洞

场景：根据输入用户id查询用户详细信息，由于没有对用户id进行匹配，导致可以查询所有用户的详细信息

![image-20211028160912361](img/漏洞代码说明.assets/image-20211028160912361.png)

![image-20211028160954476](img/漏洞代码说明.assets/image-20211028160954476.png)

**漏洞修复**

在进行查询前，对用户id进行匹配，如果不符合就停止查询

![image-20211028161119592](img/漏洞代码说明.assets/image-20211028161119592.png)

#### 垂直越权漏洞

场景：仅存在一个场景，只能有管理员访问，但是由于没有对权限进行限制，导致其他权限用户也可以访问

![image-20211028161232444](img/漏洞代码说明.assets/image-20211028161232444.png)

**漏洞修复**

在访问前对当前用户身份进行匹配，整体框架可以使用shiro等管理框架进行匹配

![image-20211028161338729](img/漏洞代码说明.assets/image-20211028161338729.png)

### 任意文件上传漏洞

由于没有对用户上传文件内容进行限制，导致攻击者可以上传任意文件

![image-20211028161823445](img/漏洞代码说明.assets/image-20211028161823445.png)

**漏洞修复**

1、对文件后缀名进行判断，限制为图片格式

![image-20211028161920479](img/漏洞代码说明.assets/image-20211028161920479.png)

2、对文件MIME进行限制，限制为图片

![image-20211028162005684](img/漏洞代码说明.assets/image-20211028162005684.png)

3、对文件具体内容进行读取判断

这里使用javax里的ImageIO方法进行读取判断，防止图片码

![image-20211028162104343](img/漏洞代码说明.assets/image-20211028162104343.png)

### XML注入漏洞

XML解析时没有对外部输入进行限制，导致引入外部实体从而执行任意命令

#### DOM解析函数

![image-20211028162551127](img/漏洞代码说明.assets/image-20211028162551127.png)

#### SAX解析函数

![image-20211028162654057](img/漏洞代码说明.assets/image-20211028162654057.png)

#### JDOM解析函数

![image-20211028162638822](img/漏洞代码说明.assets/image-20211028162638822.png)

#### DOM4J解析函数

![image-20211028162513638](img/漏洞代码说明.assets/image-20211028162513638.png)

#### Stax解析

![image-20211028162711421](img/漏洞代码说明.assets/image-20211028162711421.png)

**修复方案**

```
dbf.setFeature("http://apache.org/xml/features/disallow-doctype-decl",true);

dbf.setFeature("http://xml.org/sax/features/external-general-entities",false)

dbf.setFeature("http://xml.org/sax/features/external-parameter-entities",false);
//禁止允许外部实体引用
dbf.setFeature("http://apache.org/xml/features/nonvalidating/load-external-dtd",false);
```

### 路径穿越漏洞

#### 任意文件读取漏洞

解析展示给用户文件内容，由于没有对特殊字符进行过滤，导致任意文件读取漏洞

![image-20211028163108456](img/漏洞代码说明.assets/image-20211028163108456.png)

#### 任意目录读取

读取目录下文件展示给用户，由于没有对特殊字符进行过滤，导致任意目录读取漏洞

![image-20211028163153702](img/漏洞代码说明.assets/image-20211028163153702.png)

**修复方案**

对`..`以及`/`进行过滤限制即可，同时注意编码绕过的情况

![image-20211028163302466](img/漏洞代码说明.assets/image-20211028163302466.png)

### SSRF（跨站请求伪造）漏洞

该漏洞主要出现在对外进行创建处，如果没有对传入的url进行合理的判断，很容易出现SSRF漏洞

![image-20211028163726960](img/漏洞代码说明.assets/image-20211028163726960.png)

![image-20211028163804007](img/漏洞代码说明.assets/image-20211028163804007.png)

**漏洞修复**

采用白名单方式对需要连接的URL进行判断，优点是简单不会被绕过，缺点是比较难以管理白名单列表

![image-20211028164017717](img/漏洞代码说明.assets/image-20211028164017717.png)

![image-20211028164045973](img/漏洞代码说明.assets/image-20211028164045973.png)

